# Payment Gateway API

A .NET-based payment processing gateway that validates payment requests, processes them through a bank, and enables payment retrieval.

## Core Features
- Process payments with card validation
- Payment retrieval by ID with masked card details
- Idempotent payment processing (If the ``x-idempotency-token`` header is set, the payment ID will match its value; otherwise, a new payment ID will be generated by the backend.)


## Considerations
- Add authentication/authorization
- Implement mediator design using MediatR
- Implement rate limiting
- Add API key validation
- Encrypt sensitive data


## Prerequisites

- .NET 8.0 SDK
- Docker Desktop or Podman Desktop
- Visual Studio Code or Visual Studio 2022 or Rider

## Getting Started

### Running Locally

1. Clone the repository:
```bash
git clone https://github.com/gokerakc/payment-gateway-challenge-dotnet.git
cd payment-gateway-challenge-dotnet
```

2. Build the solution:
```bash
dotnet build
```

3. Run the tests:
```bash
dotnet test
```

4. Start the bank simulator and API:
```bash
docker-compose up bank_simulator -d
dotnet run --project src/PaymentGateway.Api
```

### Running with Docker

Build and run everything using Docker Compose:

```bash
docker-compose up --build -d
```

The API will be available at:
- HTTP: http://localhost:5001
- Swagger UI: http://localhost:5001/swagger

## Testing

The solution includes multiple test projects:

- Unit Tests: `PaymentGateway.UnitTests`
- Integration Tests: `PaymentGateway.IntegrationTests`

Run all tests:
```bash
dotnet test
```

Run specific test project:
```bash
dotnet test test/PaymentGateway.UnitTests
```

## Testing with Postman

A Postman collection is included to help you test the API endpoints manually.

1. Import the collection:
    - Open Postman
    - Click "Import"
    - Select `PaymentGateway.postman_collection.json` from the repository root

2. Run the requests:
    - **Make Payment**: Creates a new payment
        - Success case: Even card number (e.g., 4111111111111111)
        - Decline case: Odd card number (e.g., 4111111111111112)
        - Service temporarily not available case: Card number ends with 0 (e.g., 4111111111111110)
    - **Get Payment**: Retrieves payment details using the payment ID from the previous response

Note: Ensure the API is running (either locally or via Docker) before executing the requests.

Example successful payment response:
```json
{
    "id": "89199bd0-1ab7-461f-a318-81c41ae9b516",
    "status": "Authorized",
    "cardNumberLastFour": "3673",
    "expiryMonth": 5,
    "expiryYear": 2027,
    "currency": "GBP",
    "amount": 5000
}
```

## API Endpoints

### Make Payment

```http
POST /api/payments
Content-Type: application/json
x-merchant-id: your-merchant-id
x-idempotency-token: 123e4567-e89b-12d3-a456-426614174000

{
  "cardNumber": "4111111111111111",
  "expiryMonth": 12,
  "expiryYear": 2025,
  "currency": "GBP",
  "amount": 1000,
  "cvv": "123"
}
```

| Status Code | Description |
|------------|-------------|
| 200 OK | Payment processed successfully. Returns payment details including status (Authorized/Declined) |
| 400 Bad Request | Invalid request payload or validation failure (e.g., invalid card number, expired card) |
| 409 Conflict | Payment with the same idempotency token already exists |
| 500 Internal Server Error | Unexpected server-side error |
| 503 Service Unavailable | Bank service is temporarily unavailable |

### Retrieve Payment

```http
GET /api/payments/{paymentId}
x-merchant-id: your-merchant-id
```

| Status Code | Description |
|------------|-------------|
| 200 OK | Payment found and returned successfully |
| 404 Not Found | Payment with the specified ID does not exist |
| 500 Internal Server Error | Unexpected server-side error |


## Errors

All error responses follow the RFC 7807 Problem Details standard:

```json
{
    "type": "https://tools.ietf.org/html/rfc9110#section-15.6.4",
    "title": "Error title",
    "status": 400,
    "detail": "Detailed error message"
}
```

## Project Structure

```
├── src/
│   └── PaymentGateway.Api/           # Main API project
│       ├── Features/                 # API endpoints and contracts
│       ├── Domain/                   # Domain models and services
│       ├── Infrastructure/           # External dependencies implementation
│       └── Ports/                    # Interfaces for infrastructure
├── test/
│   ├── PaymentGateway.UnitTests/        # Unit tests
│   └── PaymentGateway.IntegrationTests/ # Integration tests
├── imposters/                        # Bank simulator configuration
├── .editorconfig                     # Code style rules
├── .gitignore                        # Git ignore rules
├── PaymentGateway.sln                # Solution file
├── payment-gateway.postman_collection.json # Postman collection for testing
├── README.md                         # Project documentation
└── docker-compose.yml                # Docker compose configuration
```
